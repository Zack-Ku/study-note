



# 重要概念

- **Znode**： Zookeeper将所有数据存储在内存中，数据模型是一棵树（Znode Tree)，由斜杠（/）的进行分割的路径，就是一个Znode，例如/foo/path1。每个上都会保存自己的数据内容，同时还会保存一系列属性信息。

- **SEQUENTIAL属性**：当节点被创建时，会自动在其节点名后面追加上一个整型数字，这个整型数字是一个由父节点维护的自增数字。

- **Stat版本**：对应每个Node，会有对应的Stat。其中包含三个种版本，**version**（当前ZNode的版本）、**cversion**（当前ZNode子节点的版本）和 **aversion**（当前ZNode的ACL版本）。

- **Watch（事件监听器）**：在指定节点上注册一些Watcher，并且在一些特定事件触发的时候，ZooKeeper服务端会将事件通知到感兴趣的客户端上去。
- **ACL（AccessControlLists）**：权限控制，类似UNIX系统权限控制。对节点进行增删读写和设置节点权限的权限控制。



# 重要特性

- **顺序一致性：** 从同一客户端发起的事务请求，最终将会严格地按照顺序被应用到 ZooKeeper 中去。

- **原子性：** 所有事务请求的处理结果在整个集群中所有机器上的应用情况是一致的，也就是说，要么整个集群中所有的机器都成功应用了某一个事务，要么都没有应用。

- **单一系统映像 ：** 无论客户端连到哪一个 ZooKeeper 服务器上，其看到的服务端数据模型都是一致的。

- **可靠性：** 一旦一次更改请求被应用，更改的结果就会被持久化，直到被下一次更改覆盖



# 临时节点、持久节点(数据层面)

- **临时节点** ：当创建临时节点的客户端会话一直保持活动，瞬时节点就一直存在。而当会话终结时，瞬时节点被删除。
- **持久节点**：持久节点是指一旦这个ZNode被创建了，除非主动进行ZNode的移除操作，否则这个ZNode将一直保存在Zookeeper上。



# 集群模式

**三种角色**：

- Leader：所有集群选出一个Leader。负责处理和处理事务，保证集群事务处理的顺序。
- Follower：处理客户端非事务请求，转发事务给Leader；参与事务请求Proposal投票；参与Leader选举投票
- Observer：Follower类似，但不参与Leader选举



**选主过程**：当 Leader 服务器异常时，ZAB 协议就会进人恢复模式并重新选Leader。

1. Leader election（选举阶段）：节点在一开始都处于选举阶段，只要有一个节点得到超半数节点的票数，它就可以当选准 leader。
2. Discovery（发现阶段）：在这个阶段，followers 跟准 leader 进行通信，同步 followers 最近接收的事务提议。
3. Synchronization（同步阶段）:同步阶段主要是利用 leader 前一阶段获得的最新提议历史，同步集群中所有的副本。同步完成之后 准 leader 才会成为真正的 leader。
4. Broadcast（广播阶段） 到了这个阶段，Zookeeper 集群才能正式对外提供事务服务，并且 leader 可以进行消息广播。同时如果有新的节点加入，还需要对新节点进行同步。



#Zab协议（**原子广播**）

为分布式协调服务 ZooKeeper 专门设计的一种支持崩溃恢复的原子广播协议。

两种模式：

- **崩溃恢复**：当Leader异常或框架启动的时候，则会进入崩溃恢复模式。有过半服务与Leader数据同步完后则会退出该模式。
- **消息广播**：有过半Follow和Leader数据同步，则进入消息广播。如果此时集群中已经存在一个Leader服务器在负责进行消息广播，那么新加人的服务器就会自觉地进人数据恢复模式：找到Leader所在的服务器，并与其进行数据同步，然后一起参与到消息广播流程中去。Leader服务器在接收到客户端的事务请求后，会生成对应的事务提案并发起一轮广播协议；



# ZK分布式锁

